default_platform(:android)

APP_PACKAGE      = "com.nogeass.passalarm"
FASTFILE_DIR     = File.dirname(File.realpath(__FILE__))
PROJECT_DIR      = File.expand_path("../../apps/android", FASTFILE_DIR)
METADATA_PATH    = File.expand_path("metadata/android", FASTFILE_DIR)
SCREENSHOTS_PATH = File.expand_path("screenshots", FASTFILE_DIR)

def max_play_version_code
  max_code = 0
  %w[internal alpha beta production].each do |track|
    begin
      codes = google_play_track_version_codes(
        package_name: APP_PACKAGE,
        track: track
      )
      max_code = [max_code, *codes].max if codes.any?
    rescue => e
      UI.message("âš ï¸ Could not fetch version codes from '#{track}': #{e.message}")
    end
  end
  max_code
end

platform :android do
  desc "Build debug APK"
  lane :build do
    gradle(project_dir: PROJECT_DIR, task: "assembleDebug")
  end

  desc "Run unit tests"
  lane :test do
    gradle(project_dir: PROJECT_DIR, task: "testDebugUnitTest")
  end

  desc "Capture screenshots on emulator"
  lane :screenshots do
    gradle(project_dir: PROJECT_DIR, task: "assembleDebug")
    gradle(project_dir: PROJECT_DIR, task: "assembleAndroidTest")
    capture_android_screenshots(
      app_package_name: APP_PACKAGE,
      app_apk_path: "#{PROJECT_DIR}/app/build/outputs/apk/debug/app-debug.apk",
      tests_apk_path: "#{PROJECT_DIR}/app/build/outputs/apk/androidTest/debug/app-debug-androidTest.apk",
      locales: ["ja-JP", "en-US"],
      clear_previous_screenshots: true,
      output_directory: SCREENSHOTS_PATH,
      use_tests_in_classes: ["com.nogeass.passalarm.ScreenshotTest"]
    )
  end

  desc "Upload metadata only (no binary)"
  lane :upload_metadata do
    supply(
      package_name: APP_PACKAGE,
      metadata_path: METADATA_PATH,
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_changelogs: false
    )
  end

  desc "Deploy beta to Google Play internal track"
  lane :beta do |options|
    version = options[:version] || "0.0.1"
    next_code = max_play_version_code + 1
    UI.message("ðŸ“¦ Next versionCode: #{next_code}")
    gradle(
      project_dir: PROJECT_DIR,
      task: "bundleRelease",
      properties: {
        "versionName" => version,
        "versionCode" => next_code.to_s
      }
    )
    supply(
      package_name: APP_PACKAGE,
      track: "internal",
      aab: "#{PROJECT_DIR}/app/build/outputs/bundle/release/app-release.aab",
      skip_upload_metadata: true,
      skip_upload_changelogs: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )
  end

  desc "Deploy to production and submit for review"
  lane :release do |options|
    version = options[:version] || "1.0.0"
    next_code = max_play_version_code + 1
    UI.message("ðŸ“¦ Next versionCode: #{next_code}")
    gradle(
      project_dir: PROJECT_DIR,
      task: "bundleRelease",
      properties: {
        "versionName" => version,
        "versionCode" => next_code.to_s
      }
    )
    supply(
      package_name: APP_PACKAGE,
      track: "production",
      aab: "#{PROJECT_DIR}/app/build/outputs/bundle/release/app-release.aab",
      metadata_path: METADATA_PATH,
      skip_upload_screenshots: false
    )
  end
end
